/**
 * apeman react package for image component.
 * @class ApImage
 */

'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _reactDom = require('react-dom');

var _reactDom2 = _interopRequireDefault(_reactDom);

var _classnames = require('classnames');

var _classnames2 = _interopRequireDefault(_classnames);

var _numcal = require('numcal');

var _numcal2 = _interopRequireDefault(_numcal);

var _scaled_size = require('./sizing/scaled_size');

var _scaled_size2 = _interopRequireDefault(_scaled_size);

var _apemanReactSpinner = require('apeman-react-spinner');

var _apemanReactMixinPure = require('apeman-react-mixin-pure');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/** @lends ApImage */
var ApImage = _react2.default.createClass({
  displayName: 'ApImage',


  // --------------------
  // Specs
  // --------------------

  propTypes: {
    /** Image scaling policy */
    scale: _react.PropTypes.oneOf(['fit', 'fill', 'none']),
    /** Image width */
    width: _react.PropTypes.oneOfType([_react.PropTypes.number, _react.PropTypes.string]),
    /** Image height */
    height: _react.PropTypes.oneOfType([_react.PropTypes.number, _react.PropTypes.string]),
    /** Image src string */
    src: _react.PropTypes.string,
    /** Alt test */
    alt: _react.PropTypes.string,
    /** Them of spinner */
    spinnerTheme: _react.PropTypes.string,
    /** Handler on image load */
    onLoad: _react.PropTypes.func,
    /** Handler on image error. */
    onError: _react.PropTypes.func
  },

  mixins: [_apemanReactMixinPure.ApPureMixin],

  statics: {
    scaledSize: _scaled_size2.default,
    zeroIfNaN: function zeroIfNaN(value) {
      return isNaN(value) ? 0 : value;
    },
    nullIfNaN: function nullIfNaN(value) {
      return isNaN(value) ? null : value;
    }
  },

  getInitialState: function getInitialState() {
    var s = this;
    return {
      imgWidth: null,
      imgHeight: null,
      mounted: false,
      ready: false,
      loading: !!s.props.src,
      error: null
    };
  },
  getDefaultProps: function getDefaultProps() {
    return {
      scale: 'none',
      width: 300,
      height: 150,
      src: null,
      alt: 'NO IMAGE',
      spinnerTheme: _apemanReactSpinner.ApSpinner.DEFAULT_THEME,
      onLoad: null,
      onError: null
    };
  },
  render: function render() {
    var s = this;
    var state = s.state;
    var props = s.props;
    var handleLoad = s.handleLoad;
    var handleError = s.handleError;
    var _props$width = props.width;
    var width = _props$width === undefined ? null : _props$width;
    var _props$height = props.height;
    var height = _props$height === undefined ? null : _props$height;
    var src = props.src;
    var alt = props.alt;
    var mounted = state.mounted;
    var error = state.error;
    var ready = state.ready;
    var loading = state.loading;
    var imgWidth = state.imgWidth;
    var imgHeight = state.imgHeight;

    var className = (0, _classnames2.default)('ap-image', props.className, {
      'ap-image-loading': src && loading,
      'ap-image-ready': src && ready
    });
    return _react2.default.createElement(
      'div',
      { className: className,
        style: (0, _assign2.default)({ width: width, height: height }, props.style) },
      mounted && error ? _react2.default.createElement(ApImage.Alt, { alt: alt }) : null,
      mounted && !error ? _react2.default.createElement(ApImage.Img, (0, _extends3.default)({ alt: alt,
        src: src
      }, { imgWidth: imgWidth, imgHeight: imgHeight, handleLoad: handleLoad, handleError: handleError })) : null,
      loading ? _react2.default.createElement(_apemanReactSpinner.ApSpinner, { className: 'ap-image-spinner',
        size: 'xx-large',
        theme: props.spinnerTheme,
        style: { width: width, height: height } }) : null
    );
  },


  // --------------------
  // Lifecycle
  // --------------------

  componentWillMount: function componentWillMount() {
    var s = this;
  },
  componentDidMount: function componentDidMount() {
    var s = this;
    s.setState({
      mounted: true
    });
    s._resizeTimer = setTimeout(function () {
      if (!s.state.mounted) {
        return;
      }
      s.elm = _reactDom2.default.findDOMNode(s);
      s.resizeImage();
    }, 0);
  },
  componentWillUnmount: function componentWillUnmount() {
    var s = this;
    s.setState({
      mounted: false
    });
    s.elm = null;
    clearTimeout(s._resizeTimer);
  },
  componentWillReceiveProps: function componentWillReceiveProps(nextProps) {
    var s = this;
    var props = s.props;

    var srcChanged = nextProps.src !== props.src;
    if (srcChanged) {
      s.setState({
        ready: false,
        loading: true,
        error: null
      });
      setTimeout(function () {
        return s.resizeImage();
      }, 0);
      return;
    }
    var widthChanged = nextProps.width !== props.width;
    var heightChanged = nextProps.height !== props.height;
    if (widthChanged || heightChanged) {
      setTimeout(function () {
        return s.resizeImage();
      }, 0);
    }
  },


  // ------------------
  // Helper
  // ------------------

  handleLoad: function handleLoad(e) {
    var s = this;
    var props = s.props;
    var _e$target = e.target;
    var width = _e$target.width;
    var height = _e$target.height;

    setTimeout(function () {
      return s.resizeImage(width, height);
    }, 0);

    s.setState({
      error: null,
      ready: true,
      loading: false
    });

    if (props.onLoad) {
      props.onLoad(e);
    }
  },
  handleError: function handleError(e) {
    var s = this;
    var props = s.props;


    s.setState({
      error: e,
      loading: false
    });

    if (props.onError) {
      props.onError(e);
    }
  },
  resizeImage: function resizeImage(imgContentWidth, imgContentHeight) {
    var s = this;
    var state = s.state;
    var props = s.props;
    var elm = s.elm;

    if (!elm) {
      return false;
    }

    imgContentWidth = imgContentWidth || state.imgContentWidth;
    imgContentHeight = imgContentHeight || state.imgContentHeight;

    var valid = imgContentWidth && imgContentHeight;
    if (!valid) {
      return;
    }

    var frameSize = {
      width: elm.offsetWidth,
      height: elm.offsetHeight
    };
    var contentSize = {
      height: imgContentHeight,
      width: imgContentWidth
    };
    var scaledSize = ApImage.scaledSize(contentSize, frameSize, props.scale);

    s.setState({
      imgContentWidth: imgContentWidth,
      imgContentHeight: imgContentHeight,
      imgWidth: scaledSize.width || imgContentWidth,
      imgHeight: scaledSize.height || imgContentHeight,
      ready: true,
      loading: false
    });
  },


  elm: null

});

(0, _assign2.default)(ApImage, {
  Img: function Img(_ref) {
    var src = _ref.src;
    var alt = _ref.alt;
    var imgWidth = _ref.imgWidth;
    var imgHeight = _ref.imgHeight;
    var handleLoad = _ref.handleLoad;
    var handleError = _ref.handleError;
    var nullIfNaN = ApImage.nullIfNaN;


    var style = {
      width: nullIfNaN(imgWidth),
      height: nullIfNaN(imgHeight)
    };
    return _react2.default.createElement('img', { src: src,
      alt: alt,
      className: (0, _classnames2.default)('ap-image-content'),
      style: style,
      onLoad: handleLoad,
      onError: handleError
    });
  },
  Alt: function Alt(_ref2) {
    var height = _ref2.height;
    var alt = _ref2.alt;

    var style = {
      lineHeight: height + 'px',
      fontSize: _numcal2.default.min(height * 0.4, 18) + 'px'
    };
    return _react2.default.createElement(
      'div',
      { className: 'ap-image-notfound',
        style: style
      },
      alt
    );
  }
});

exports.default = ApImage;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwX2ltYWdlLmpzeCJdLCJuYW1lcyI6WyJBcEltYWdlIiwiY3JlYXRlQ2xhc3MiLCJwcm9wVHlwZXMiLCJzY2FsZSIsIm9uZU9mIiwid2lkdGgiLCJvbmVPZlR5cGUiLCJudW1iZXIiLCJzdHJpbmciLCJoZWlnaHQiLCJzcmMiLCJhbHQiLCJzcGlubmVyVGhlbWUiLCJvbkxvYWQiLCJmdW5jIiwib25FcnJvciIsIm1peGlucyIsInN0YXRpY3MiLCJzY2FsZWRTaXplIiwiemVyb0lmTmFOIiwidmFsdWUiLCJpc05hTiIsIm51bGxJZk5hTiIsImdldEluaXRpYWxTdGF0ZSIsInMiLCJpbWdXaWR0aCIsImltZ0hlaWdodCIsIm1vdW50ZWQiLCJyZWFkeSIsImxvYWRpbmciLCJwcm9wcyIsImVycm9yIiwiZ2V0RGVmYXVsdFByb3BzIiwiREVGQVVMVF9USEVNRSIsInJlbmRlciIsInN0YXRlIiwiaGFuZGxlTG9hZCIsImhhbmRsZUVycm9yIiwiY2xhc3NOYW1lIiwic3R5bGUiLCJjb21wb25lbnRXaWxsTW91bnQiLCJjb21wb25lbnREaWRNb3VudCIsInNldFN0YXRlIiwiX3Jlc2l6ZVRpbWVyIiwic2V0VGltZW91dCIsImVsbSIsImZpbmRET01Ob2RlIiwicmVzaXplSW1hZ2UiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsImNsZWFyVGltZW91dCIsImNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiLCJuZXh0UHJvcHMiLCJzcmNDaGFuZ2VkIiwid2lkdGhDaGFuZ2VkIiwiaGVpZ2h0Q2hhbmdlZCIsImUiLCJ0YXJnZXQiLCJpbWdDb250ZW50V2lkdGgiLCJpbWdDb250ZW50SGVpZ2h0IiwidmFsaWQiLCJmcmFtZVNpemUiLCJvZmZzZXRXaWR0aCIsIm9mZnNldEhlaWdodCIsImNvbnRlbnRTaXplIiwiSW1nIiwiQWx0IiwibGluZUhlaWdodCIsImZvbnRTaXplIiwibWluIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7QUFLQTs7Ozs7Ozs7Ozs7Ozs7QUFFQTs7OztB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VyxrQkFBWCxDQUZqQjtBQUdLLGFBQVE0QixLQUhiO0FBSUssY0FBU0gsVUFKZDtBQUtLLGVBQVVDO0FBTGYsTUFERjtBQVNELEdBbkJvQjtBQXFCckI0QixLQXJCcUIsc0JBcUJDO0FBQUEsUUFBZnhELE1BQWUsU0FBZkEsTUFBZTtBQUFBLFFBQVBFLEdBQU8sU0FBUEEsR0FBTzs7QUFDcEIsUUFBSTRCLFFBQVE7QUFDVjJCLGtCQUFlekQsTUFBZixPQURVO0FBRVYwRCxnQkFBYSxpQkFBT0MsR0FBUCxDQUFXM0QsU0FBUyxHQUFwQixFQUF5QixFQUF6QixDQUFiO0FBRlUsS0FBWjtBQUlBLFdBQ0U7QUFBQTtBQUFBLFFBQUssV0FBVSxtQkFBZjtBQUNLLGVBQVE4QjtBQURiO0FBRUc1QjtBQUZILEtBREY7QUFLRDtBQS9Cb0IsQ0FBdkI7O2tCQWtDZVgsTyIsImZpbGUiOiJhcF9pbWFnZS5qc3giLCJzb3VyY2VSb290IjoibGliIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBhcGVtYW4gcmVhY3QgcGFja2FnZSBmb3IgaW1hZ2UgY29tcG9uZW50LlxuICogQGNsYXNzIEFwSW1hZ2VcbiAqL1xuXG4ndXNlIHN0cmljdCdcblxuaW1wb3J0IFJlYWN0LCB7IFByb3BUeXBlcyBhcyB0eXBlcyB9IGZyb20gJ3JlYWN0J1xuaW1wb3J0IFJlYWN0RE9NIGZyb20gJ3JlYWN0LWRvbSdcbmltcG9ydCBjbGFzc25hbWVzIGZyb20gJ2NsYXNzbmFtZXMnXG5pbXBvcnQgbnVtY2FsIGZyb20gJ251bWNhbCdcbmltcG9ydCBzY2FsZWRTaXplIGZyb20gJy4vc2l6aW5nL3NjYWxlZF9zaXplJ1xuaW1wb3J0IHsgQXBTcGlubmVyIH0gZnJvbSAnYXBlbWFuLXJlYWN0LXNwaW5uZXInXG5pbXBvcnQgeyBBcFB1cmVNaXhpbiB9IGZyb20gJ2FwZW1hbi1yZWFjdC1taXhpbi1wdXJlJ1xuXG4vKiogQGxlbmRzIEFwSW1hZ2UgKi9cbmNvbnN0IEFwSW1hZ2UgPSBSZWFjdC5jcmVhdGVDbGFzcyh7XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy8gU3BlY3NcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuICBwcm9wVHlwZXM6IHtcbiAgICAvKiogSW1hZ2Ugc2NhbGluZyBwb2xpY3kgKi9cbiAgICBzY2FsZTogdHlwZXMub25lT2YoW1xuICAgICAgJ2ZpdCcsXG4gICAgICAnZmlsbCcsXG4gICAgICAnbm9uZSdcbiAgICBdKSxcbiAgICAvKiogSW1hZ2Ugd2lkdGggKi9cbiAgICB3aWR0aDogdHlwZXMub25lT2ZUeXBlKFsgdHlwZXMubnVtYmVyLCB0eXBlcy5zdHJpbmcgXSksXG4gICAgLyoqIEltYWdlIGhlaWdodCAqL1xuICAgIGhlaWdodDogdHlwZXMub25lT2ZUeXBlKFsgdHlwZXMubnVtYmVyLCB0eXBlcy5zdHJpbmcgXSksXG4gICAgLyoqIEltYWdlIHNyYyBzdHJpbmcgKi9cbiAgICBzcmM6IHR5cGVzLnN0cmluZyxcbiAgICAvKiogQWx0IHRlc3QgKi9cbiAgICBhbHQ6IHR5cGVzLnN0cmluZyxcbiAgICAvKiogVGhlbSBvZiBzcGlubmVyICovXG4gICAgc3Bpbm5lclRoZW1lOiB0eXBlcy5zdHJpbmcsXG4gICAgLyoqIEhhbmRsZXIgb24gaW1hZ2UgbG9hZCAqL1xuICAgIG9uTG9hZDogdHlwZXMuZnVuYyxcbiAgICAvKiogSGFuZGxlciBvbiBpbWFnZSBlcnJvci4gKi9cbiAgICBvbkVycm9yOiB0eXBlcy5mdW5jXG4gIH0sXG5cbiAgbWl4aW5zOiBbXG4gICAgQXBQdXJlTWl4aW5cbiAgXSxcblxuICBzdGF0aWNzOiB7XG4gICAgc2NhbGVkU2l6ZSxcbiAgICB6ZXJvSWZOYU4gKHZhbHVlKSB7XG4gICAgICByZXR1cm4gaXNOYU4odmFsdWUpID8gMCA6IHZhbHVlXG4gICAgfSxcbiAgICBudWxsSWZOYU4gKHZhbHVlKSB7XG4gICAgICByZXR1cm4gaXNOYU4odmFsdWUpID8gbnVsbCA6IHZhbHVlXG4gICAgfVxuICB9LFxuXG4gIGdldEluaXRpYWxTdGF0ZSAoKSB7XG4gICAgY29uc3QgcyA9IHRoaXNcbiAgICByZXR1cm4ge1xuICAgICAgaW1nV2lkdGg6IG51bGwsXG4gICAgICBpbWdIZWlnaHQ6IG51bGwsXG4gICAgICBtb3VudGVkOiBmYWxzZSxcbiAgICAgIHJlYWR5OiBmYWxzZSxcbiAgICAgIGxvYWRpbmc6ICEhcy5wcm9wcy5zcmMsXG4gICAgICBlcnJvcjogbnVsbFxuICAgIH1cbiAgfSxcblxuICBnZXREZWZhdWx0UHJvcHMgKCkge1xuICAgIHJldHVybiB7XG4gICAgICBzY2FsZTogJ25vbmUnLFxuICAgICAgd2lkdGg6IDMwMCxcbiAgICAgIGhlaWdodDogMTUwLFxuICAgICAgc3JjOiBudWxsLFxuICAgICAgYWx0OiAnTk8gSU1BR0UnLFxuICAgICAgc3Bpbm5lclRoZW1lOiBBcFNwaW5uZXIuREVGQVVMVF9USEVNRSxcbiAgICAgIG9uTG9hZDogbnVsbCxcbiAgICAgIG9uRXJyb3I6IG51bGxcbiAgICB9XG4gIH0sXG5cbiAgcmVuZGVyICgpIHtcbiAgICBjb25zdCBzID0gdGhpc1xuICAgIGxldCB7XG4gICAgICBzdGF0ZSxcbiAgICAgIHByb3BzLFxuICAgICAgaGFuZGxlTG9hZCxcbiAgICAgIGhhbmRsZUVycm9yXG4gICAgfSA9IHNcblxuICAgIGxldCB7XG4gICAgICB3aWR0aCA9IG51bGwsXG4gICAgICBoZWlnaHQgPSBudWxsLFxuICAgICAgc3JjLFxuICAgICAgYWx0XG4gICAgfSA9IHByb3BzXG5cbiAgICBsZXQge1xuICAgICAgbW91bnRlZCwgZXJyb3IsIHJlYWR5LCBsb2FkaW5nLCBpbWdXaWR0aCwgaW1nSGVpZ2h0XG4gICAgfSA9IHN0YXRlXG4gICAgbGV0IGNsYXNzTmFtZSA9IGNsYXNzbmFtZXMoJ2FwLWltYWdlJywgcHJvcHMuY2xhc3NOYW1lLCB7XG4gICAgICAnYXAtaW1hZ2UtbG9hZGluZyc6IHNyYyAmJiBsb2FkaW5nLFxuICAgICAgJ2FwLWltYWdlLXJlYWR5Jzogc3JjICYmIHJlYWR5XG4gICAgfSlcbiAgICByZXR1cm4gKFxuICAgICAgPGRpdiBjbGFzc05hbWU9eyBjbGFzc05hbWUgfVxuICAgICAgICAgICBzdHlsZT17IE9iamVjdC5hc3NpZ24oeyB3aWR0aCwgaGVpZ2h0IH0sIHByb3BzLnN0eWxlKSB9PlxuICAgICAgICB7XG4gICAgICAgICAgbW91bnRlZCAmJiBlcnJvciA/IChcbiAgICAgICAgICAgIDxBcEltYWdlLkFsdCBhbHQ9eyBhbHQgfS8+XG4gICAgICAgICAgKSA6IG51bGxcbiAgICAgICAgfVxuICAgICAgICB7XG4gICAgICAgICAgbW91bnRlZCAmJiAhZXJyb3IgPyAoXG4gICAgICAgICAgICA8QXBJbWFnZS5JbWcgYWx0PXsgYWx0IH1cbiAgICAgICAgICAgICAgICAgICAgICAgICBzcmM9eyBzcmMgfVxuICAgICAgICAgICAgICAgICAgICAgICAgIHsgLi4ueyBpbWdXaWR0aCwgaW1nSGVpZ2h0LCBoYW5kbGVMb2FkLCBoYW5kbGVFcnJvciB9IH1cbiAgICAgICAgICAgIC8+XG4gICAgICAgICAgKSA6IG51bGxcbiAgICAgICAgfVxuICAgICAgICB7IGxvYWRpbmcgPyAoXG4gICAgICAgICAgPEFwU3Bpbm5lciBjbGFzc05hbWU9J2FwLWltYWdlLXNwaW5uZXInXG4gICAgICAgICAgICAgICAgICAgICBzaXplPSd4eC1sYXJnZSdcbiAgICAgICAgICAgICAgICAgICAgIHRoZW1lPXsgcHJvcHMuc3Bpbm5lclRoZW1lIH1cbiAgICAgICAgICAgICAgICAgICAgIHN0eWxlPXsgeyB3aWR0aCwgaGVpZ2h0IH0gfS8+XG4gICAgICAgICkgOiBudWxsIH1cbiAgICAgIDwvZGl2PlxuICAgIClcbiAgfSxcblxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBMaWZlY3ljbGVcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuICBjb21wb25lbnRXaWxsTW91bnQgKCkge1xuICAgIGNvbnN0IHMgPSB0aGlzXG4gIH0sXG5cbiAgY29tcG9uZW50RGlkTW91bnQgKCkge1xuICAgIGNvbnN0IHMgPSB0aGlzXG4gICAgcy5zZXRTdGF0ZSh7XG4gICAgICBtb3VudGVkOiB0cnVlXG4gICAgfSlcbiAgICBzLl9yZXNpemVUaW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgaWYgKCFzLnN0YXRlLm1vdW50ZWQpIHtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICBzLmVsbSA9IFJlYWN0RE9NLmZpbmRET01Ob2RlKHMpXG4gICAgICBzLnJlc2l6ZUltYWdlKClcbiAgICB9LCAwKVxuICB9LFxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50ICgpIHtcbiAgICBjb25zdCBzID0gdGhpc1xuICAgIHMuc2V0U3RhdGUoe1xuICAgICAgbW91bnRlZDogZmFsc2VcbiAgICB9KVxuICAgIHMuZWxtID0gbnVsbFxuICAgIGNsZWFyVGltZW91dChzLl9yZXNpemVUaW1lcilcbiAgfSxcblxuICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIChuZXh0UHJvcHMpIHtcbiAgICBjb25zdCBzID0gdGhpc1xuICAgIGxldCB7IHByb3BzIH0gPSBzXG4gICAgbGV0IHNyY0NoYW5nZWQgPSBuZXh0UHJvcHMuc3JjICE9PSBwcm9wcy5zcmNcbiAgICBpZiAoc3JjQ2hhbmdlZCkge1xuICAgICAgcy5zZXRTdGF0ZSh7XG4gICAgICAgIHJlYWR5OiBmYWxzZSxcbiAgICAgICAgbG9hZGluZzogdHJ1ZSxcbiAgICAgICAgZXJyb3I6IG51bGxcbiAgICAgIH0pXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHMucmVzaXplSW1hZ2UoKSwgMClcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICBsZXQgd2lkdGhDaGFuZ2VkID0gbmV4dFByb3BzLndpZHRoICE9PSBwcm9wcy53aWR0aFxuICAgIGxldCBoZWlnaHRDaGFuZ2VkID0gbmV4dFByb3BzLmhlaWdodCAhPT0gcHJvcHMuaGVpZ2h0XG4gICAgaWYgKHdpZHRoQ2hhbmdlZCB8fCBoZWlnaHRDaGFuZ2VkKSB7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHMucmVzaXplSW1hZ2UoKSwgMClcbiAgICB9XG4gIH0sXG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIEhlbHBlclxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS1cblxuICBoYW5kbGVMb2FkIChlKSB7XG4gICAgY29uc3QgcyA9IHRoaXNcbiAgICBsZXQgeyBwcm9wcyB9ID0gc1xuICAgIGxldCB7IHdpZHRoLCBoZWlnaHQgfSA9IGUudGFyZ2V0XG4gICAgc2V0VGltZW91dCgoKSA9PiBzLnJlc2l6ZUltYWdlKHdpZHRoLCBoZWlnaHQpLCAwKVxuXG4gICAgcy5zZXRTdGF0ZSh7XG4gICAgICBlcnJvcjogbnVsbCxcbiAgICAgIHJlYWR5OiB0cnVlLFxuICAgICAgbG9hZGluZzogZmFsc2VcbiAgICB9KVxuXG4gICAgaWYgKHByb3BzLm9uTG9hZCkge1xuICAgICAgcHJvcHMub25Mb2FkKGUpXG4gICAgfVxuICB9LFxuXG4gIGhhbmRsZUVycm9yIChlKSB7XG4gICAgY29uc3QgcyA9IHRoaXNcbiAgICBsZXQgeyBwcm9wcyB9ID0gc1xuXG4gICAgcy5zZXRTdGF0ZSh7XG4gICAgICBlcnJvcjogZSxcbiAgICAgIGxvYWRpbmc6IGZhbHNlXG4gICAgfSlcblxuICAgIGlmIChwcm9wcy5vbkVycm9yKSB7XG4gICAgICBwcm9wcy5vbkVycm9yKGUpXG4gICAgfVxuICB9LFxuXG4gIHJlc2l6ZUltYWdlIChpbWdDb250ZW50V2lkdGgsIGltZ0NvbnRlbnRIZWlnaHQpIHtcbiAgICBjb25zdCBzID0gdGhpc1xuICAgIGxldCB7IHN0YXRlLCBwcm9wcywgZWxtIH0gPSBzXG4gICAgaWYgKCFlbG0pIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cblxuICAgIGltZ0NvbnRlbnRXaWR0aCA9IGltZ0NvbnRlbnRXaWR0aCB8fCBzdGF0ZS5pbWdDb250ZW50V2lkdGhcbiAgICBpbWdDb250ZW50SGVpZ2h0ID0gaW1nQ29udGVudEhlaWdodCB8fCBzdGF0ZS5pbWdDb250ZW50SGVpZ2h0XG5cbiAgICBsZXQgdmFsaWQgPSBpbWdDb250ZW50V2lkdGggJiYgaW1nQ29udGVudEhlaWdodFxuICAgIGlmICghdmFsaWQpIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGxldCBmcmFtZVNpemUgPSB7XG4gICAgICB3aWR0aDogZWxtLm9mZnNldFdpZHRoLFxuICAgICAgaGVpZ2h0OiBlbG0ub2Zmc2V0SGVpZ2h0XG4gICAgfVxuICAgIGxldCBjb250ZW50U2l6ZSA9IHtcbiAgICAgIGhlaWdodDogaW1nQ29udGVudEhlaWdodCxcbiAgICAgIHdpZHRoOiBpbWdDb250ZW50V2lkdGhcbiAgICB9XG4gICAgbGV0IHNjYWxlZFNpemUgPSBBcEltYWdlLnNjYWxlZFNpemUoXG4gICAgICBjb250ZW50U2l6ZSwgZnJhbWVTaXplLCBwcm9wcy5zY2FsZVxuICAgIClcblxuICAgIHMuc2V0U3RhdGUoe1xuICAgICAgaW1nQ29udGVudFdpZHRoLFxuICAgICAgaW1nQ29udGVudEhlaWdodCxcbiAgICAgIGltZ1dpZHRoOiBzY2FsZWRTaXplLndpZHRoIHx8IGltZ0NvbnRlbnRXaWR0aCxcbiAgICAgIGltZ0hlaWdodDogc2NhbGVkU2l6ZS5oZWlnaHQgfHwgaW1nQ29udGVudEhlaWdodCxcbiAgICAgIHJlYWR5OiB0cnVlLFxuICAgICAgbG9hZGluZzogZmFsc2VcbiAgICB9KVxuICB9LFxuXG4gIGVsbTogbnVsbFxuXG59KVxuXG5PYmplY3QuYXNzaWduKEFwSW1hZ2UsIHtcbiAgSW1nICh7XG4gICAgc3JjLCBhbHQsIGltZ1dpZHRoLCBpbWdIZWlnaHQsIGhhbmRsZUxvYWQsIGhhbmRsZUVycm9yXG4gIH0pIHtcbiAgICBsZXQgeyBudWxsSWZOYU4gfSA9IEFwSW1hZ2VcblxuICAgIGxldCBzdHlsZSA9IHtcbiAgICAgIHdpZHRoOiBudWxsSWZOYU4oaW1nV2lkdGgpLFxuICAgICAgaGVpZ2h0OiBudWxsSWZOYU4oaW1nSGVpZ2h0KVxuICAgIH1cbiAgICByZXR1cm4gKFxuICAgICAgPGltZyBzcmM9eyBzcmMgfVxuICAgICAgICAgICBhbHQ9eyBhbHQgfVxuICAgICAgICAgICBjbGFzc05hbWU9eyBjbGFzc25hbWVzKCdhcC1pbWFnZS1jb250ZW50JykgfVxuICAgICAgICAgICBzdHlsZT17IHN0eWxlIH1cbiAgICAgICAgICAgb25Mb2FkPXsgaGFuZGxlTG9hZCB9XG4gICAgICAgICAgIG9uRXJyb3I9eyBoYW5kbGVFcnJvciB9XG4gICAgICAvPlxuICAgIClcbiAgfSxcblxuICBBbHQgKHsgaGVpZ2h0LCBhbHQgfSkge1xuICAgIGxldCBzdHlsZSA9IHtcbiAgICAgIGxpbmVIZWlnaHQ6IGAke2hlaWdodH1weGAsXG4gICAgICBmb250U2l6ZTogYCR7bnVtY2FsLm1pbihoZWlnaHQgKiAwLjQsIDE4KX1weGBcbiAgICB9XG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXYgY2xhc3NOYW1lPVwiYXAtaW1hZ2Utbm90Zm91bmRcIlxuICAgICAgICAgICBzdHlsZT17IHN0eWxlIH1cbiAgICAgID57IGFsdCB9PC9kaXY+XG4gICAgKVxuICB9XG59KVxuXG5leHBvcnQgZGVmYXVsdCBBcEltYWdlXG4iXX0=